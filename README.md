# postgres-deployer
DevOps test task for PostgresPro  
[Оригинальное задание](https://sblnk.ru/cbf05a45e411)
## Описание
Консольное приложение, которое:
* Проводит оценку загруженности серверов, выбирая наименее нагруженный как целевой;
* устанавливает PostgreSQL на целевой хост;
* Настраивает PostgreSQL для приема внешних соединений;
* Настраивает подключение пользователя “student” к PostgreSQL только с ip адреса второго сервера.
## Запуск
1. Склонируйте репозиторий:
   ```bash
   git clone https://github.com/n1klze/postgres-deployer.git
   ```
2. Запустите deploy.py:
   ```bash
   python deploy.py <server1,server2>
   ```
   , где `server1`, `server2` — ip адреса целевых серверов
   
   Пример:
   ```bash
   python deploy.py 192.168.56.101,192.168.56.102
   ```
4. Дождитесь завершения программы.
## Проверка работы
После успешной установки вы можете проверить подключение к PostgreSQL с другого сервера:
```bash
psql -h target_server_ip -U student -d postgres
```

## Принятые решения
1. **Подключение по SSH**: происходит с помощью ключа, находящегося в `~/.ssh/id_rsa`

2. **Выбор сервера**: Для выбора наименее нагруженного сервера используется средняя нагрузка за 1 минуту из `/proc/loadavg`.

3. **Установка PostgreSQL**: Происходит после подключения пакетного репозитория PGDG (PostgreSQL Global Development Group). Устанавливается целевая версия, указанная в `ansible/vars/main.yml` (по умолчанию 16)
   ```Yaml
   pg_version: 16
   ```

4. **Настройка доступа**:
   - Изменяется `listen_addresses = '*'` в `postgresql.conf`
   - Добавляется правило в pg_hba.conf для ограничения доступа пользователя “student” только со второго сервера

5. **Проверка работы**: Выполняется простой SQL-запрос `SELECT 1`

Тестирование проводилось с помощью 2-х выритуальных машин, развёрнутых в VirtualBox, с установленными дистрибутивами `Debian 12.10.0` и `AlmaLinux 9`.
